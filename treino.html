<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Periodiza√ß√£o Ondulat√≥ria ‚Äî Treino 6x/semana</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f1115">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Wave Training">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Chama a imagem de fundo -->
  <link rel="stylesheet" href="style.css?v=1"> 
  
  <style>
    :root{
      --bg:#0f1115; --panel:#151923; --muted:#a6adbb; --text:#e8ecf1;
      --accent:#6ee7ff; --accent2:#a78bfa; --card:#1b2230; --border:#273043; --yellow:#facc15;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;padding-bottom:env(safe-area-inset-bottom, 16px);}

    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(15,17,21,.98), rgba(15,17,21,.86));position:sticky;top:0;z-index:5;backdrop-filter:saturate(140%) blur(6px)}
    h1{font-size:clamp(1.15rem, 3.5vw, 1.6rem);margin:0 0 4px 0}
    .sub{font-size:12px;color:var(--muted)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .rowlabel{color:var(--muted);font-size:12px;margin:6px 2px}

    /* controles */
    select, button{font:600 14px/1 system-ui; border:0; border-radius:10px; padding:10px 12px}
    select{background:var(--card); color:var(--text); border:1px solid var(--border)}
    button{background:var(--accent); color:#07202a; cursor:pointer}
    button:hover{background:var(--accent2)}
    .wkbtn.done{ background:var(--accent2); color:var(--card); }
    #wkLabel.done::after{ content:" ‚úì"; color:var(--accent2); font-weight:700; }

    @media (max-width:360px){
      header .controls{flex-wrap:wrap}
      header .controls > *{flex:1 1 auto}
      button, select{width:100%}
    }

    /* cards gen√©ricos */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;overflow:hidden}
    .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .small{font-size:11px;color:var(--muted)}
    .empty{padding:10px;border:1px dashed var(--border);border-radius:10px;color:var(--muted);text-align:center}

    /* carrossel de dias */
    .days{display:flex; gap:12px; padding:12px; overflow-x:auto; scroll-snap-type:x mandatory}
    .days::-webkit-scrollbar{height:6px}
    .days::-webkit-scrollbar-thumb{background:#2a3140; border-radius:999px}
    .day-card{
      flex:0 0 85vw; max-width:360px; scroll-snap-align:start;
      background:var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:12px; box-shadow:0 6px 22px rgba(0,0,0,.25);
    }
    .rest{border:1px dashed var(--border);background:transparent;color:var(--muted);display:flex;align-items:center;justify-content:center;min-height:160px}

    /* tabela do dia */
    table{width:100%;border-collapse:separate;border-spacing:0 8px;table-layout:auto}
    th{font-size:12px;color:var(--muted);font-weight:600;text-align:left}
    td{font-size:.95rem;padding:6px 8px;vertical-align:middle;background:#11161f;border-radius:8px}
    td:first-child{width:45%;word-break:break-word;hyphens:auto;line-height:1.2}
    .sets-input,.reps-input,.carga-input{
      width:3.8ch;text-align:center;font-weight:700;font-size:.95rem;border-radius:8px;border:1px solid #2a3140;background:#0c1119;color:var(--text);padding:6px 4px
    }

    /* gr√°ficos */
    .charts{margin-top:18px}
    .chart-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:10px 0}
    .chart-title{font-size:13px;color:var(--muted);margin:0 0 8px}
    .chart-wrap{height:420px}

    /* total da sess√£o */
    .totals{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:8px}

    /* esconder blocos vazios */
    .card:empty,[data-empty="true"]{display:none !important}

    @media (min-width:992px){
      .days{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); overflow:visible}
      .day-card{flex:1 1 auto; max-width:unset}
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Periodiza√ß√£o Ondulat√≥ria ‚Äî 12 semanas</h1>
      <div class="sub">Workspace: <code id="ws-label"></code></div>
      <div class="small" id="src-badge"></div>
    </div>
    <div class="controls" style="display:flex;gap:8px;align-items:center">
      <label id="wkLabel">Semana:
        <select id="week"></select>
      </label>
      <button id="wkDoneBtn" class="wkbtn" title="Concluir/Reabrir semana">Concluir semana</button>
    </div>
  </header>

  <div class="wrap">
    <div class="rowlabel">Faixa alvo de repeti√ß√µes da semana: <b id="repRange">‚Äî</b></div>

    <div id="workouts-row" class="days"></div>

    <section class="charts">
      <h2 style="font-size:16px;margin:18px 0 8px">üìà Evolu√ß√£o do seu treino</h2>

      <div class="chart-card">
        <p class="chart-title">Evolu√ß√£o do Volume Semanal (12 semanas)</p>
        <div class="chart-wrap"><canvas id="chartWeekly"></canvas></div>
      </div>

      <div class="chart-card" id="avgChartWrap">
        <p class="chart-title">M√©dia de repeti√ß√µes por exerc√≠cio ‚Äî Semana atual</p>
        <div id="custom-avg-chart"></div>
        <div id="avgChart-message" style="display:none; text-align:center; padding: 20px; color: var(--muted)">Nenhum dado de treino para esta semana.</div>
      </div>
    </section>
    
    <section class="charts">
      <h2 style="font-size:16px;margin:18px 0 8px">üí™ Exerc√≠cios da semana</h2>
      <div class="chart-card" id="all-exercises-list"></div>
    </section>

    <p class="small" id="testStatus"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc,
      enableIndexedDbPersistence, query, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // === Firebase config (o seu) ===
    const firebaseConfig = {
      apiKey: "AIzaSyAN9B0dCAIfVPmGZ6qUUfC8k9KnrUT5ymI",
      authDomain: "treino-ondulatoriov5.firebaseapp.com",
      projectId: "treino-ondulatoriov5",
      storageBucket: "treino-ondulatoriov5.firebasestorage.app",
      messagingSenderId: "152908725685",
      appId: "1:152908725685:web:ca42dc3714fe07af162dfc"
    };

    // Workspace (?ws=) ‚Äî ID do usu√°rio
    const params = new URLSearchParams(location.search);
    const rawWs = (params.get('ws') || '').trim();
    const wkFromUrl = Number(params.get('wk'));
    if (!rawWs) { location.href = 'index.html'; }
    const userId = rawWs;
    document.getElementById('ws-label').textContent = userId;

    // Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    // Ciclo de 12 semanas
    const weeks = [
      {id:1,reps:"12‚Äì15",treg:false},{id:2,reps:"4‚Äì6",treg:false},{id:3,reps:"8‚Äì10",treg:false},{id:4,reps:"12‚Äì15",treg:false},
      {id:5,reps:"12‚Äì15",treg:true},{id:6,reps:"4‚Äì6",treg:false},{id:7,reps:"8‚Äì10",treg:false},{id:8,reps:"12‚Äì15",treg:false},
      {id:9,reps:"12‚Äì15",treg:true},{id:10,reps:"4‚Äì6",treg:false},{id:11,reps:"8‚Äì10",treg:false},{id:12,reps:"12‚Äì15",treg:false}
    ];

    const repRangeLbl = document.getElementById('repRange');
    const weekSelect = document.getElementById('week');
    const wkDoneBtn  = document.getElementById('wkDoneBtn');
    const wkLabelEl  = document.getElementById('wkLabel');
    const allExercisesList = document.getElementById('all-exercises-list');
    const workoutsRow = document.getElementById('workouts-row');
    const avgChartMessageDiv = document.getElementById('avgChart-message');

    // preencher semanas
    weeks.forEach(week => {
      const opt = document.createElement('option');
      opt.value = week.id;
      opt.textContent = `Semana ${week.id}`;
      weekSelect.appendChild(opt);
    });

    // helpers
    const el=(t,a={})=>Object.assign(document.createElement(t),a);
    const formatNum=n=>(Number(n)||0).toLocaleString('pt-BR',{maximumFractionDigits:2});
    const vol=o=>Math.round((Number(o.sets)||0)*(Number(o.reps)||0)*(Number(o.carga)||0)*100)/100;
    function sessionSum(arr){ return arr.reduce((a,o)=>a+vol(o),0); }
    function attachSessionFooter(container, data){
      const totalsWrap = el('div',{className:'totals'});
      totalsWrap.append(el('div',{textContent:`Total da sess√£o: ${formatNum(sessionSum(data))}`}));
      container.append(totalsWrap);
    }

    // ====== Progresso de semanas ======
    let currentWeekId = 1;
    let weekStatus = {}; // { "1": {completed:true, completedAt:...}, ... }

    async function loadProgress() {
      const userRef = doc(db, 'users', userId);
      const snap = await getDoc(userRef);
      if (!snap.exists()) return { currentWeek: null, weekStatus: {} };
      const data = snap.data() || {};
      weekStatus = data.weekStatus || {};
      return { currentWeek: Number(data.currentWeek) || null, weekStatus };
    }

    async function setCurrentWeek(weekId){
      await setDoc(doc(db, 'users', userId), { currentWeek: weekId }, { merge: true });
    }

    async function saveWeekStatus(weekId, completed){
      const patch = { [`weekStatus.${weekId}.completed`]: completed };
      if (completed) patch[`weekStatus.${weekId}.completedAt`] = serverTimestamp();
      await setDoc(doc(db, 'users', userId), patch, { merge: true });
      weekStatus[weekId] = { ...(weekStatus[weekId]||{}), completed };
    }

    function isWeekCompleted(id){ return !!weekStatus?.[id]?.completed; }

    function refreshWeekDoneUI(){
      const done = isWeekCompleted(currentWeekId);
      wkDoneBtn.textContent = done ? 'Reabrir semana' : 'Concluir semana';
      wkDoneBtn.classList.toggle('done', done);
      wkLabelEl.classList.toggle('done', done);
    }

    async function pickInitialWeek(){
      const { currentWeek, weekStatus: ws } = await loadProgress();
      // 1) URL tem wk?
      if (wkFromUrl >= 1 && wkFromUrl <= 12){
        currentWeekId = wkFromUrl;
        await setCurrentWeek(currentWeekId);
        return;
      }
      // 2) tem currentWeek salvo?
      if (currentWeek && currentWeek >=1 && currentWeek <=12){
        currentWeekId = currentWeek;
        return;
      }
      // 3) primeira n√£o conclu√≠da; sen√£o 12
      for (let i=1;i<=12;i++){
        if (!ws?.[i]?.completed){ currentWeekId = i; return; }
      }
      currentWeekId = 12;
    }

    function updateWeekLabel(){
      weekSelect.value = String(currentWeekId);
      const w = weeks.find(x=>x.id==currentWeekId);
      repRangeLbl.textContent = w ? w.reps + (w.treg ? ' ¬∑ TREG' : '') : '‚Äî';
    }

    wkDoneBtn.addEventListener('click', async ()=>{
      const done = isWeekCompleted(currentWeekId);
      const newState = !done;
      await saveWeekStatus(currentWeekId, newState);

      if (newState){
        // avan√ßar para pr√≥xima n√£o conclu√≠da
        let next = currentWeekId;
        for (let i=currentWeekId+1;i<=12;i++){
          if (!isWeekCompleted(i)){ next = i; break; }
          next = i; // se todas conclu√≠das at√© o fim, fica na √∫ltima
        }
        currentWeekId = next;
        await setCurrentWeek(currentWeekId);
      } else {
        // reabriu: fica nela
        await setCurrentWeek(currentWeekId);
      }

      updateWeekLabel();
      refreshWeekDoneUI();
      await loadUserSchedule();
      await updateCharts();
    });

    weekSelect.addEventListener('change', async ()=>{
      currentWeekId = Number(weekSelect.value) || 1;
      await setCurrentWeek(currentWeekId);
      updateWeekLabel();
      refreshWeekDoneUI();
      await loadUserSchedule();
      await updateCharts();
    });

    // ====== UI de treino ======
    function createWorkoutDayCard(dayName, workout, workoutId) {
      const card = document.createElement('section');
      card.className = 'day-card card workout-day-card';
      card.dataset.workoutId = workoutId;

      const title = el('div',{className:'title'});
      title.innerHTML = `<h3>${dayName} ¬∑ ${(workout.name ?? workout.nome) || 'Treino sem nome'}</h3>
                         <button class="edit-btn">Editar</button>`;
      card.appendChild(title);

      const table = el('table');
      table.innerHTML = `
        <thead>
          <tr><th>Exerc√≠cio</th><th>S√©ries</th><th>Reps</th><th>Carga (kg)</th><th>Volume</th></tr>
        </thead>
        <tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      (workout.exercises||[]).forEach(ex => {
        const tr = document.createElement('tr');
        const name = (ex.nome||'').split(' - ')[1] || ex.nome || '';
        tr.innerHTML = `
          <td>${name}</td>
          <td><input type="number" class="sets-input"  value="${ex.sets??0}"  disabled></td>
          <td><input type="number" class="reps-input"  value="${ex.reps??0}"  disabled></td>
          <td><input type="number" class="carga-input" value="${ex.carga??0}" disabled></td>
          <td><span class="volume-span">${vol(ex)}</span></td>`;
        tbody.appendChild(tr);
      });
      card.appendChild(table);

      attachSessionFooter(card, workout.exercises||[]);

      const editBtn = card.querySelector('.edit-btn');
      editBtn.addEventListener('click', () => {
        const inputs = card.querySelectorAll('.sets-input,.reps-input,.carga-input');
        const editing = editBtn.textContent === 'Editar';
        editBtn.textContent = editing ? 'Salvar' : 'Editar';
        inputs.forEach(i => {
          if (editing){ i.removeAttribute('disabled'); i.style.border='1px solid var(--border)'; }
          else        { i.setAttribute('disabled', true); i.style.border='none'; }
        });
        if (!editing) saveWorkoutChanges(card, workoutId);
      });

      return card;
    }

    async function saveWorkoutChanges(card, workoutId) {
      const exercises = [];
      card.querySelectorAll('tbody tr').forEach(row => {
        const name  = row.querySelector('td:first-child').textContent.trim();
        const sets  = parseFloat(row.querySelector('.sets-input').value)  || 0;
        const reps  = parseFloat(row.querySelector('.reps-input').value)  || 0;
        const carga = parseFloat(row.querySelector('.carga-input').value) || 0;
        exercises.push({ nome: name, sets, reps, carga });
      });
      const title = card.querySelector('h3')?.textContent || '';
      const nameFromTitle = title.includes('¬∑') ? title.split('¬∑')[1].trim() : title.trim();

      const workoutRef = doc(db, `users/${userId}/weeks/${currentWeekId}/workouts`, workoutId);
      await setDoc(workoutRef, { name: nameFromTitle, exercises }, { merge: true });
      alert("Altera√ß√µes salvas com sucesso!");
      await loadUserSchedule();
    }

    async function loadUserSchedule() {
      const wMeta = weeks.find(w => w.id == currentWeekId);
      repRangeLbl.textContent = wMeta ? wMeta.reps + (wMeta.treg ? ' ¬∑ TREG' : '') : '‚Äî';

      const userRef = doc(db, 'users', userId);
      const userSnap = await getDoc(userRef);
      workoutsRow.innerHTML = '';

      if (userSnap.exists() && userSnap.data().workoutSchedule) {
        const schedule = userSnap.data().workoutSchedule;
        const workoutIds = Object.values(schedule);
        const uniqueIds = [...new Set(workoutIds)];

        const baseSnaps = await Promise.all(uniqueIds.map(id => getDoc(doc(db, `users/${userId}/workouts/${id}`))));
        const weekSnaps = await Promise.all(uniqueIds.map(id => getDoc(doc(db, `users/${userId}/weeks/${currentWeekId}/workouts/${id}`))));

        const map = {};
        baseSnaps.forEach(s => { if (s.exists()) map[s.id] = {...(map[s.id]||{}), ...s.data()}; });
        weekSnaps.forEach(s => { if (s.exists()) map[s.id] = {...(map[s.id]||{}), ...s.data()}; });

        const days = ['Dia 1','Dia 2','Dia 3','Dia 4','Dia 5','Dia 6','Dia 7'];
        const allExercises = new Set();

        for (const day of days){
          const wid = schedule[day];
          if (wid && map[wid]){
            const card = createWorkoutDayCard(day, map[wid], wid);
            workoutsRow.appendChild(card);
            (map[wid].exercises||[]).forEach(ex => allExercises.add(ex.nome));
          } else {
            const rest = document.createElement('section');
            rest.className = 'day-card card rest';
            rest.textContent = 'DESCANSO';
            workoutsRow.appendChild(rest);
          }
        }

        const sorted = Array.from(allExercises).sort();
        displayAllWeeklyExercises(sorted);
        await updateCharts();
      } else {
        workoutsRow.innerHTML = `
          <div class="card">
            <p class="empty">Nenhum treino programado para este usu√°rio.</p>
            <div style="text-align:right"><a href="workout_builder.html?ws=${userId}"><button>Criar Novo Treino</button></a></div>
          </div>`;
        allExercisesList.innerHTML = '';
        await updateCharts();
      }
    }

    function displayAllWeeklyExercises(exercises) {
      allExercisesList.innerHTML = '';
      if (exercises.length > 0) {
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.padding = '0';
        ul.style.margin = '0';
        ul.style.columnCount = '2';
        ul.style.gap = '10px';
        exercises.forEach(ex => {
          const li = document.createElement('li');
          const name = (ex || '').split(' - ')[1] || ex || '';
          li.textContent = name;
          ul.appendChild(li);
        });
        allExercisesList.appendChild(ul);
      } else {
        allExercisesList.innerHTML = '<p style="margin:0;color:var(--muted)">Nenhum exerc√≠cio encontrado para esta semana.</p>';
      }
    }

    // ===== Gr√°ficos =====
    let weeklyChart=null;
    async function buildChartsIfNeeded(){
      const weeklyVolumes = await getAllWeeksVolumes();
      if(!weeklyChart){
        const ctxW = document.getElementById('chartWeekly').getContext('2d');
        weeklyChart = new Chart(ctxW, {
          type: 'line',
          data: { labels: weeks.map(w=>'S'+w.id), datasets: [{ label: 'Volume semanal', data: weeklyVolumes }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
      }
    }
    async function updateCharts(){
      const weeklyVolumes = await getAllWeeksVolumes();
      const avgRows = await getWeekExerciseAvgRepsRows(currentWeekId);

      if(weeklyChart){ weeklyChart.data.datasets[0].data = weeklyVolumes; weeklyChart.update(); }

      if(avgRows.length > 0) {
        avgChartMessageDiv.style.display = 'none';
        const container = document.getElementById('custom-avg-chart');
        container.innerHTML = '';
        const maxReps = Math.max(...avgRows.map(r => r.avgReps));
        avgRows.forEach(row => {
          const item = el('div', { className: 'avg-rep-item', style:'display:flex;align-items:center;margin-bottom:6px;font-size:12px' });
          const label = el('span', { style:'width:40%;text-align:right;padding-right:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis', textContent: row.nome });
          const barC = el('div', { style:'flex:1;background:var(--bg);border-radius:4px;height:12px;overflow:hidden' });
          const bar = el('div', { style:`height:100%;background:linear-gradient(90deg, var(--accent), var(--accent2));width:${(row.avgReps/maxReps)*100}%` });
          barC.appendChild(bar); item.appendChild(label); item.appendChild(barC); container.appendChild(item);
        });
      } else {
        avgChartMessageDiv.style.display = 'block';
        document.getElementById('custom-avg-chart').innerHTML = '';
      }
    }
    async function getWeekVolume(weekId){
      const snap = await getDocs(query(collection(db, `users/${userId}/weeks/${weekId}/workouts`)));
      let total = 0;
      snap.forEach(d => (d.data().exercises||[]).forEach(ex => total += vol(ex)));
      return total;
    }
    async function getAllWeeksVolumes(){ return Promise.all(weeks.map(w => getWeekVolume(w.id))); }
    async function getWeekExerciseAvgRepsRows(weekId){
      const map = new Map();
      const snap = await getDocs(query(collection(db, `users/${userId}/weeks/${weekId}/workouts`)));
      snap.forEach(doc => {
        (doc.data().exercises||[]).forEach(o => {
          const name=(o.nome||'').split(' - ')[1] || o.nome || '';
          const entry=map.get(name)||{sumReps:0,count:0,sumVol:0};
          entry.sumReps += Number(o.reps)||0;
          entry.count   += 1;
          entry.sumVol  += vol(o);
          map.set(name,entry);
        });
      });
      const rows=[...map.entries()].map(([nome,{sumReps,count,sumVol}])=>({ nome, avgReps: count? (sumReps/count):0, sumVol }));
      rows.sort((a,b)=>b.sumVol-a.sumVol-b.count+a.count);
      return rows;
    }

    // Init
    (async function init(){
      signInAnonymously(auth).catch(console.error);
      document.getElementById('testStatus').textContent = 'Autotestes: 1/1 OK';

      await pickInitialWeek();
      updateWeekLabel();
      refreshWeekDoneUI();

      await loadUserSchedule();
      await buildChartsIfNeeded();
      await updateCharts();
    })();
  </script>

  <!-- SW (uma vez s√≥) -->
  <script>
    (function () {
      if (!('serviceWorker' in navigator)) return;
      navigator.serviceWorker.register('./service-worker.js', { scope: './' }).catch(console.warn);
    })();
  </script>
</body>
</html>
